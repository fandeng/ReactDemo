//紧急联系人界面
import React, { Component } from 'react';
import  {
  AppRegistry,
  StyleSheet,
  Text,
  View,
  ScrollView,
  Dimensions,
  TouchableOpacity,
  InteractionManager
} from 'react-native';

import Common from '../common/common';
import HeaderView from '../common/HeaderView';

import EmergencyContactContainer from '../components/EmergencyContact';
import ResponseData from '../Data/Response.json';
import REQUEST_JSON from '../Data/Request.json';
var DataRepository = require('../Data/DataRepository');
var repository = new DataRepository();
import { toastShort } from '../utils/ToastUtil';

class EmergencyContactVC extends Component {
  constructor(props) {
	  super(props);
	  this.state = {
	  	ecdata:this.props.userdata.emergency_contacts[0],
      isFinsh: this.props.isFinsh
	  };
	}
  state = {
      data: []
  }
  _callContactback(dataArray) {
    this.setState({
        data: dataArray,
    });
    console.log(dataArray);
  }
  render() {
    return (
      <View>
        <HeaderView  titleView= {'紧急联系人'}
        leftIcon={'angle-left'}
        leftIconAction={() => this.props.navigator.pop() }
        rightButton={this.props.isFinsh?'确认':''}
        collectIconAction={() => this.onPressHandler()}/>
        {
          <ScrollView style={{backgroundColor:'#f0f1f2',height: Common.window.height-64,width:Common.window.width}}>
             <EmergencyContactContainer callContactback={this._callContactback.bind(this)} emcdata={this.props.userdata.emergency_contacts[0]} isApply={this.props.isFinsh}/>
             <TouchableOpacity
                 activeOpacity={0.5}
                 onPress={()=>this.onPressHandler()}
                 style={styles.center}>
                 <View style = {[styles.addContainer_style,{backgroundColor:(this.props.isFinsh?'#1a98ff':'rgba(255.0, 255.0, 255.0, 0)')}]}>
                     <Text style={{color:'white',fontSize:15}}>{this.props.isFinsh?'添加联系人':''}</Text>
                 </View>
             </TouchableOpacity>
          </ScrollView>
        }
      </View>
    );
  }
  onPressHandler = () => {
      InteractionManager.runAfterInteractions(() => {
          if (this.props.isFinsh==false) {
            return;
          }
          if (this.state.data[0] ==undefined) {
            toastShort('请输入姓名');
          } else if (this.isName(this.state.data[0])) {
            toastShort('姓名只能输入2~20个中文');
          } else if (this.state.data[1] ==undefined) {
            toastShort('请输入电话');
          } else if (this.isPhoneNum(this.state.data[1])) {
            toastShort('请输正确的入电话号码');
          } else if (this.state.data[2] ==undefined) {
            toastShort('请输入住址');
          } else if (this.state.data[3] ==undefined) {
            toastShort('请输入关系');
          } else {
            this.request();
          }
      });
  }
  request() {
      var modifyuserinfo = REQUEST_JSON.modifyuserinfo;
      modifyuserinfo.userid = '123';
      let contacts = {name: this.state.data[0], phone: this.state.data[1], address: this.state.data[2],relation:this.state.data[3]}
      modifyuserinfo.emergency_contacts = [contacts];
      repository.launchRequest('modifyuserinfo',modifyuserinfo).then((responseData) => {
          alert(responseData.retinfo.retmsg)
          this.props.navigator.pop()
      }).done();
  }
  isName(str){
    var regu='^[\\u4e00-\\u9fa5]{2,20}$';
    var re = new RegExp(regu);
    return !re.test(str);
  }
  isPhoneNum(str){
		var regu='^(1[2-9])\\d{9}$';
		var re = new RegExp(regu);
		return !re.test(str);
	}
}
const styles = StyleSheet.create({
    addContainer_style:{
      marginTop:20,
      marginLeft:10,
      marginRight:10,
      backgroundColor:'#1a98ff',
      height:40,
      borderRadius:5,
      justifyContent: 'center',
      alignItems: 'center',
    },
});
module.exports = EmergencyContactVC;
