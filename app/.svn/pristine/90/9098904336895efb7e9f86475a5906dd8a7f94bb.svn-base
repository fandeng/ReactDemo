import React,{Component} from 'react';
import{
	StyleSheet,
	Text,
	View,
	BackAndroid,
	Platform,
	TouchableOpacity,
	Image,
TextInput,
 ToastAndroid,
	ScrollView,
	Navigator,
} from 'react-native';

import Common from '../common/common';
import Register from '../pages/Register';

import REQUEST_JSON from '../Data/Request.json';
var DataRepository = require('../Data/DataRepository');
var repository = new DataRepository();
var  Response =require('../Data/Response');
import StyleImport from '../style/style';
import { toastShort } from '../utils/ToastUtil';

var showNum='获取验证码';
var Radius=10;   //圆角角度

var phoneNum='';
var password='';

var loginNum=0;

const REGISTER_FLAG=0;
const LOGIN_FLAG=2;


var month_but_width=Common.window.width-60;

var base64Icon = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEsAAABLCAQAAACSR7JhAAADtUlEQVR4Ac3YA2Bj6QLH0XPT1Fzbtm29tW3btm3bfLZtv7e2ObZnms7d8Uw098tuetPzrxv8wiISrtVudrG2JXQZ4VOv+qUfmqCGGl1mqLhoA52oZlb0mrjsnhKpgeUNEs91Z0pd1kvihA3ULGVHiQO2narKSHKkEMulm9VgUyE60s1aWoMQUbpZOWE+kaqs4eLEjdIlZTcFZB0ndc1+lhB1lZrIuk5P2aib1NBpZaL+JaOGIt0ls47SKzLC7CqrlGF6RZ09HGoNy1lYl2aRSWL5GuzqWU1KafRdoRp0iOQEiDzgZPnG6DbldcomadViflnl/cL93tOoVbsOLVM2jylvdWjXolWX1hmfZbGR/wjypDjFLSZIRov09BgYmtUqPQPlQrPapecLgTIy0jMgPKtTeob2zWtrGH3xvjUkPCtNg/tm1rjwrMa+mdUkPd3hWbH0jArPGiU9ufCsNNWFZ40wpwn+62/66R2RUtoso1OB34tnLOcy7YB1fUdc9e0q3yru8PGM773vXsuZ5YIZX+5xmHwHGVvlrGPN6ZSiP1smOsMMde40wKv2VmwPPVXNut4sVpUreZiLBHi0qln/VQeI/LTMYXpsJtFiclUN+5HVZazim+Ky+7sAvxWnvjXrJFneVtLWLyPJu9K3cXLWeOlbMTlrIelbMDlrLenrjEQOtIF+fuI9xRp9ZBFp6+b6WT8RrxEpdK64BuvHgDk+vUy+b5hYk6zfyfs051gRoNO1usU12WWRWL73/MMEy9pMi9qIrR4ZpV16Rrvduxazmy1FSvuFXRkqTnE7m2kdb5U8xGjLw/spRr1uTov4uOgQE+0N/DvFrG/Jt7i/FzwxbA9kDanhf2w+t4V97G8lrT7wc08aA2QNUkuTfW/KimT01wdlfK4yEw030VfT0RtZbzjeMprNq8m8tnSTASrTLti64oBNdpmMQm0eEwvfPwRbUBywG5TzjPCsdwk3IeAXjQblLCoXnDVeoAz6SfJNk5TTzytCNZk/POtTSV40NwOFWzw86wNJRpubpXsn60NJFlHeqlYRbslqZm2jnEZ3qcSKgm0kTli3zZVS7y/iivZTweYXJ26Y+RTbV1zh3hYkgyFGSTKPfRVbRqWWVReaxYeSLarYv1Qqsmh1s95S7G+eEWK0f3jYKTbV6bOwepjfhtafsvUsqrQvrGC8YhmnO9cSCk3yuY984F1vesdHYhWJ5FvASlacshUsajFt2mUM9pqzvKGcyNJW0arTKN1GGGzQlH0tXwLDgQTurS8eIQAAAABJRU5ErkJggg==';

export default class Login extends Component{
	constructor(props) {
	  super(props);
	  this.state = {
	  	sum:60,
	  	margintop:0,
	  	codeheight:0,
	  };
	}
	render(){
		
		return (
			
				<View style={{backgroundColor:'#F0F1F2',flex:1,paddingLeft:30,paddingRight:30} }>
					<TouchableOpacity style={{height:50,justifyContent: 'center',alignItems: 'flex-end'}} onPress = {this.onClick.bind(this,0)}>
						<Text style={{color:'#1a98ff'}}>注册</Text>
					</TouchableOpacity>
					<View style={{height:180,justifyContent: 'center',alignItems: 'center'}}>
						<Image style={{}} source={require('../img/emergencyContact.png')}>
						</Image>
					</View>

					<View style={{height:120,flexDirection:'column',justifyContent: 'flex-start'}}>
						<View  style={styles.phone_style}>
							<Image style = {{height:24,width:16,marginLeft:15}} source={require('../img/phone.png')}/>
							<TextInput
					          style={styles.style_input}
					          placeholder="请输入手机号"
					          underlineColorAndroid={'transparent'} 
					          numberOfLines={1}
					          onChangeText={(text) => {phoneNum=text;}}
					        />
						</View>

						<View style={{height:1,backgroundColor:'#D3D3D3',alignItems:'center'}}></View>

						<View  style={styles.password_style}>
							<Image style = {{height:24,width:16,marginLeft:15}} source={require('../img/phone.png')}/>
							
							<TextInput
					          style={styles.style_input}
					          placeholder="请输入密码"
					          underlineColorAndroid={'transparent'} 
					          numberOfLines={1}
					          secureTextEntry={true}
					          onChangeText={(text) => {password=text;}}
					        />
					    
						</View>
					</View>

					<View  style={{flexDirection:'row',justifyContent:'center',alignItems:'center',backgroundColor:'#ffffff',
									borderBottomLeftRadius:Radius,borderBottomRightRadius:Radius,
									marginTop:this.state.margintop,height:this.state.codeheight}}>
							
							<TextInput
					          style={[styles.style_input],{flex:2}}
					          placeholder="请输入验证码"
					          underlineColorAndroid={'transparent'} 
					          numberOfLines={1}
					          onChangeText={(text) => {phoneNum=text;}}
					        />
					        <View style = {{width:120,marginLeft:5,justifyContent:'center',alignItems:'center',}}>
					        <Image style = {{height:25,width:80,marginLeft:5}} source={{uri:base64Icon}}/>
					        </View>
					</View>

					<View style={{height:50,alignItems:'center',marginTop:40}}>
						<TouchableOpacity style={[StyleImport.button_style,{width:month_but_width,height:50}]}
									onPress = {this.onClick.bind(this,2)}>
									<Text style={{textAlign:'center',color:'#ffffff',fontSize:15}}>登陆</Text>
						</TouchableOpacity>

					</View>

					
				</View>
			)
	}


	onClick(item){
		if (item==REGISTER_FLAG) {
			this.props.navigator.push({
						name: '二级',
						component: Register,
				})
		}


		if (item==LOGIN_FLAG) {
			 this.interval && clearInterval(this.interval);
			 if (this.isNull(phoneNum)) {
			 	toastShort('请输入电话号码');
			 	
			 	return 
			 }
			 if (this.isNotPhoneNum(phoneNum)) {
			 	toastShort('请输正确的入电话号码');
			 	
			 	return 
			 }
			 if (this.isNull(password)) {
			 	toastShort('请输入密码');
			 	
			 	return 
			 }

			 this.request(item)

		}

		if (item==3) {
			this.setState({
				margintop:10,
	  			codeheight:60,
			});

		}

		if (item==4) {
		
			// isLoginIn(()=>{
			// 	alert("success");
			// },
			// ()=>{
			// 	alert('fail');
			// }
			// );
			// storage.load({
			// 		 key: 'userinfo',
			// 		 syncInBackground: true,
			// 	 }).then(ret=>{
			// 		// alert(ret.response_body.name+ret.response_body.address);
			// 	 }).catch(err => {console.warn(err.message);
			// 	    switch (err.name) {
			// 	        case 'NotFoundError':
			// 	           	alert('没找到。。。。');
			// 	            break;
			// 	        case 'ExpiredError':
			// 	            alert('过期了。。。。');
			// 	            break;
			// 	    }})
		}
		
	}

	request(id) {

		if (id==LOGIN_FLAG) {

			var userlogin = REQUEST_JSON.userlogin;
        	userlogin.servnum=phoneNum;
        	userlogin.password=password;
        	userlogin.logintype=10;
	        repository.launchRequest('userlogin',userlogin).then((responseData) => {
	        	console.log('request  response======>'+responseData.response_head.retinfo.retcode);
	        	if(responseData.response_head.retinfo.retcode=="0"){

	        		// alert('sdsdss');
		            storage.save({
				    key: USER_INFO,  //注意:请不要在key中使用_下划线符号!
				    rawData: responseData,

				    // 如果不指定过期时间，则会使用defaultExpires参数
				    // 如果设为null，则永不过期
				    expires: null,
				  });
		          this.props.navigator.pop();
				}else{
					alert('hahah');
					loginNum++;
					if (loginNum>=3) {
						this.setState({
							margintop:10,
				  			codeheight:60,
						})
					}
				}
	        }).done();
		}

		if (id==3) {

		}
        
    }
	componentDidMount(){
		
		 BackAndroid.addEventListener('hardwareBackPress', () => {
    		this.props.navigator.pop()
    		
    		
     		return true
		});
	}


	isNull(str){ 
		if ( str == "" ) {return true; }
		var regu = "^[ ]+$"; 
		var re = new RegExp(regu); 
		return re.test(str); 
	} 
	isNotPhoneNum(str){
		var regu='^(1[2-9])\\d{9}$';
		var re = new RegExp(regu); 
		return !re.test(str); 
	}
}







var styles =StyleSheet.create({
	view_style:{flex:1,justifyContent: 'flex-end',flexDirection:'row',height:60},
	input_style:{ marginTop: 10,
    height: 40,
    borderRadius: 5,
   	borderWidth: 1,
    borderColor: 'lightblue'},

     style_input:{  
      backgroundColor:'#fff',
      height:35,
      flex:1,
  },

   	 button: {
        width: Common.window.width-60,
        backgroundColor: '#1a98ff',
        height:40,
        alignItems:'center',justifyContent: 'center',
        borderRadius: 10,
		
    },
    phone_style:{flex:1,flexDirection:'row',justifyContent:'center',alignItems:'center'
			    ,borderTopLeftRadius:Radius,borderTopRightRadius:Radius
			    ,borderColor:'#ffffff', backgroundColor:'#FFFFFF'},

	password_style:{flex:1,flexDirection:'row',justifyContent:'center',alignItems:'center'
					,borderBottomLeftRadius:Radius,borderBottomRightRadius:Radius
					, borderColor:'#ffffff',backgroundColor:'#FFFFFF'}
});
