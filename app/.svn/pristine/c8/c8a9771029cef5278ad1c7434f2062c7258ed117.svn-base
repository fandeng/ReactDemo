//首页
import React, { Component} from 'react';
import {
    StyleSheet,
    Text,
    ScrollView,
    ListView,
    View,
    Image,
    Alert,
    Platform,
    InteractionManager,
    Dimensions,
    TouchableOpacity,
} from 'react-native';

import Common from '../common/common';
import HeaderView from '../common/HeaderView';
// import Swiper from 'react-native-swiper';
import ViewPager from 'react-native-viewpager';
import ApplyVC from '../pages/ApplyMineInformation';
import WebViewDetails from '../components/WebDetails'
import MessageVC from '../pages/MessageVC';
import ResponseData from '../Data/Response.json';
import REQUEST_JSON from '../Data/Request.json';

var DataRepository = require('../Data/DataRepository');
var repository = new DataRepository();

//轮播图片
var sliderImgs = [require("../img/swiper1.jpg"), require("../img/swiper2.jpg"), require("../img/swiper3.jpg"),
                  require("../img/swiper4.jpg"), require("../img/swiper5.jpg") ];

let webUrlArray =['http://www.xiaodatech.com/fh-web/article/discovery?discoveryId=119',
                  'http://www.xiaodatech.com/fh-web/article/discovery?discoveryId=120',
                  'http://www.xiaodatech.com/fh-web/article/discovery?discoveryId=121'
                  ];
let coverArray= [require("../img/homebg1.png"),require("../img/homebg2.png"),require("../img/homebg3.png")];
class HomePage extends Component {
  constructor(props) {
      super(props);
      this._renderRow = this.renderRow.bind(this);
      this._renderPage = this._renderPage.bind(this);
      var listdataSource= new ListView.DataSource({
            rowHasChanged: (row1, row2) => row1 !== row2,
      });
      var vpdataSource = new ViewPager.DataSource({
            pageHasChanged: (p1, p2) => p1 !== p2,
        });
        // 实际的DataSources存放在state中
        this.state = {
            listdataSource:listdataSource.cloneWithRows(ResponseData.queryloanproducts.response_body.products),
            vpdataSource: vpdataSource.cloneWithPages(ResponseData.querydiscoveryinfo1.response_body.discoverylist),
            data:ResponseData.querysysmsgs1.response_body.msgs[0]
        }
  }
  render() {
      this.requesttop();
      this.requestnotice();
      this.request();
      return(
         <View>
          <HeaderView  titleView= {'哗啦贷'}
          rightButton={'home'}
          collectIconAction={() => this.onClickMessage() }/>
          {
            <ScrollView style = {{width:Common.window.width,height:Common.window.height-64-49,backgroundColor:'#f0f1f2'}}>
              <View style={styles.topView_style}>
                 <ViewPager
                  style={{height:(Common.window.height-64)/3-10}}
                  dataSource={this.state.vpdataSource}
                  renderPage={this._renderPage}
                  isLoop={true}
                  autoPlay={true}/>
                  <View style={styles.notice_style}>
                      <Image style={styles.noticeImg_style} source={require("../img/notice.png")}/>
                      <Text style={styles.notice_text}>{this.state.data.title}</Text>
                  </View>
              </View>

              <View style={styles.midView_style}>
                 <TouchableOpacity style={styles.center}
                 activeOpacity={0.5}
								 onPress = {() => this.onClickMidItems(0)}>
                    <View style={{width:90,height:90}}>
                      <Image style = {styles.midView_child} source={require('../img/swiper_1.jpg')}/>
                      <View style={{marginBottom: 0,position: 'absolute',left: 10,right: 0,top:0}}>
                        <Text style={styles.midView_text}>我要还款</Text>
                      </View>
                    </View>
							   </TouchableOpacity>

                 <TouchableOpacity style={styles.center}
                 activeOpacity={0.5}
								 onPress = {() => this.onClickMidItems(1)}>
                      <View style={{width:90,height:90}}>
                        <Image style = {styles.midView_child} source={require('../img/swiper_2.jpg')}/>
                        <View style={{marginBottom: 0,position: 'absolute',left: 10,right: 0,top:0}}>
                          <Text style={styles.midView_text}>查询进度</Text>
                        </View>
                      </View>
							   </TouchableOpacity>

                 <TouchableOpacity style={styles.center}
                 activeOpacity={0.5}
								 onPress = {() => this.onClickMidItems(2)}>
                    <View style={{width:90,height:90}}>
                      <Image style = {styles.midView_child} source={require('../img/swiper_3.jpg')}/>
                      <View style={{marginBottom: 0,position: 'absolute',left: 10,right: 0,top:0}}>
                        <Text style={styles.midView_text}>利率计算</Text>
                      </View>
                    </View>
							   </TouchableOpacity>
              </View>

              <ListView
                  dataSource={this.state.listdataSource}
                  renderRow={this._renderRow}
                  enableEmptySections={true}
                  style={{height: 130*4}}//减去导航的高度
              />
            </ScrollView>
          }
         </View>
    );
  }
  renderRow(rowDate,sectionID, rowID, highlightRow) {
    return (
    <View style={{flex: 1,alignItems: 'center',marginTop:15,height: 130}}>
        <Image style={styles.bottomView_style} source={coverArray[rowID]}/>
        <View style={{marginBottom: 0,position: 'absolute',left: 10,right: 0,top:0}}>
            <View style={{height:20,marginTop:10,alignItems:'center',flexDirection:'row'}}>
                <Image style={[styles.bottomView_Img,{marginLeft:10}]} source={require("../img/home_left.png")}/>
                <Text style={styles.bottomView_text}>{rowDate.name}</Text>
                <Image style={[styles.bottomView_Img,{marginRight:10}]} source={require("../img/home_right.png")}/>
            </View>
            <Text style={{marginTop:5,textAlign:'center',fontSize:12,marginLeft:10,color:'white',backgroundColor:'rgba(255.0, 255.0, 255.0, 0)',}}>{rowDate.summary}</Text>

            <View style={styles.bottom_child}>
                <View style={styles.bottomchild_style}>
                    <Text style={[styles.bottomchild_text,{color:'white',marginTop:20}]}>{rowDate.quota_min}~{rowDate.quota_max}</Text>
                    <Text style={[styles.bottomchild_text,{color:'white',marginTop:10}]}>借款额度(元）</Text>
                </View>
                <View style={{marginTop:5,backgroundColor:'rgba(255.0, 255.0, 255.0, 0.5)',width:1,height:70}}/>
                <View style={styles.bottomchild_style}>
                    <Text style={[styles.bottomchild_text,{color:'white',marginTop:15}]}>借款周期(月) {rowDate.term_min}~{rowDate.term_max}个</Text>
                    <TouchableOpacity style={styles.center}
                      activeOpacity={0.5}
                      onPress = {() => this.onPressApply()}>
                      <View style = {styles.nextContainer_style}>
                         <Text style={{color:'white',fontSize:15}}>立即借款</Text>
                      </View>
                    </TouchableOpacity>
                </View>
            </View>
        </View>
    </View>
    );
  }
  //轮播图
  _renderPage(data,pageID) {
       return (
         <TouchableOpacity style={styles.center}
         activeOpacity={0.5}
         onPress={() => this.viewPagerCheck(data)}>
             <Image  source={sliderImgs[pageID]} style={styles.swiperImage_style}/>
         </TouchableOpacity>
       );
   }
  //点击事件
  onClickMessage(){
    InteractionManager.runAfterInteractions(() => {
        this.props.navigator.push({
            name: '消息',
            component: MessageVC,
        })
    });
  }
  onPressApply() {
      InteractionManager.runAfterInteractions(() => {
          this.props.navigator.push({
              name: '流程',
              component: ApplyVC,
          })
      });
  }
  viewPagerCheck(data) {
    InteractionManager.runAfterInteractions(() => {
        this.props.navigator.push({
            name: '详情',
            component: WebViewDetails,
            passProps:{
              info:data.serviceurl,
            }
        })
    });
  }
  onClickMidItems(index){
    InteractionManager.runAfterInteractions(() => {
      this.props.navigator.push({
          name: '详情',
          component: WebViewDetails,
          passProps:{
            info:webUrlArray[index],
          }
      })
    });
  }
  request() {
      var queryloanproducts = REQUEST_JSON.queryloanproducts;
      queryloanproducts.pagenum = '1';
      queryloanproducts.pagesize = '20';
      repository.launchRequest('queryloanproducts',queryloanproducts).then((responseData) => {
          console.log(responseData.response_body);
      }).done();
  }
  //此处调真实接口，需要改动
  requesttop() {
      var querydiscoveryinfo = REQUEST_JSON.querydiscoveryinfo;
      querydiscoveryinfo.userid = '123';
      querydiscoveryinfo.pushpage = '1';
      querydiscoveryinfo.pagenum = '1';
      querydiscoveryinfo.pagesize = '20';
      repository.launchRequest('querydiscoveryinfo1',querydiscoveryinfo).then((responseData) => {
          console.log(responseData.response_body);
      }).done();
  }
  requestnotice() {
      var querysysmsgs = REQUEST_JSON.querysysmsgs;
      querysysmsgs.msgtype = '2';
      querysysmsgs.pagenum = '1';
      querysysmsgs.pagesize = '20';
      repository.launchRequest('querysysmsgs1',querysysmsgs).then((responseData) => {
          console.log(responseData.response_body);
      }).done();
  }
}
const styles = StyleSheet.create({
    topView_style:{
      width:Common.window.width,
      height:(Common.window.height-64)/3+30,
      backgroundColor:'white'
    },
    swiperImage_style: {
      height:(Common.window.height-64)/3,
      width:Common.window.width
    },
    notice_style:{
      width:Common.window.width,
      height:40,
      flexDirection: 'row',
      alignItems: 'center'
    },
    noticeImg_style:{
      width:22,
      height:20,
      marginLeft:10,
    },
    notice_text:{
      textAlign:'left',
      height:18,
      marginTop:2,
      marginLeft:10,
      fontSize:14,
      color:'#666666'
    },
    midView_style:{
      width:Common.window.width-20,
      height:100,
      marginLeft:10,
      marginTop:10,
      flexDirection:'row',
      justifyContent:'space-around',
      alignItems:'center'
    },
    midView_child:{
      width:90,
      height:90,
      alignItems:'center',
      borderRadius:8,
    },
    center:{
       flexDirection: 'row',
       justifyContent: 'center',
       alignItems: 'center',
    },
    midView_text:{
      fontSize:14,
      marginTop:40,
      color:'#333333',
      backgroundColor:'rgba(255.0, 255.0, 255.0, 0)',
      textAlign:'center'
    },
    midView_image:{
      width:50,
      height:50,
      marginTop:10
    },
    bottomView_style:{
      width:Common.window.width-30,
      height:140,
      resizeMode: 'stretch',
      alignItems: 'stretch',
      flexDirection: 'row',
      justifyContent: 'flex-start',
      marginBottom: 0,
      borderRadius:5,
    },
    bottomView_Img:{
      width:(Common.window.width-30-80-30)/2,
      height:5,
    },
    bottomView_text:{
      fontSize:14,
      width:80,
      marginLeft:5,
      marginRight:5,
      color:'white',
      backgroundColor:'rgba(255.0, 255.0, 255.0, 0)',
      textAlign:'center'
    },
    bottom_child:{
      height:80,
      marginTop:5,
      marginLeft:10,
      marginRight:10,
      alignItems:'center',
      flexDirection:'row',
    },
    bottomchild_style:{
      height:80,
      width:(Common.window.width-50)/2,
      alignItems:'center',
    },
    bottomchild_text:{
      fontSize:14,
      height:20,
      width:(Common.window.width-50)/2,
      backgroundColor:'rgba(255.0, 255.0, 255.0, 0)',
      textAlign:'center'
    },
    nextContainer_style:{
      marginTop:10,
      backgroundColor:'#1a98ff',
      marginLeft:15,
      width:(Common.window.width-50)/2-30,
      height:30,
      borderRadius:5,
      justifyContent: 'center',
      alignItems: 'center',
    },
});
module.exports = HomePage;
