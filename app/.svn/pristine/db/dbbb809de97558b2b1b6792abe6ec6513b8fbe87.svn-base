'use strict';
import REQUEST_JSON from './Request.json';
var DeviceInfo = require('react-native-device-info');
var React = require('react-native');



var API_BASE_URL = 'http://112.74.205.50/babylove-web/babylove';


function parseDateFromYYYYMMdd(str) {
  if (!str) return new Date();
  return new Date(str.slice(0, 4),str.slice(4, 6) - 1,str.slice(6, 8));
}

Date.prototype.yyyymmdd = function() {
  var yyyy = this.getFullYear().toString();
  var mm = (this.getMonth()+1).toString(); // getMonth() is zero-based
  var dd  = this.getDate().toString();
  return yyyy + (mm[1]?mm:"0"+mm[0]) + (dd[1]?dd:"0"+dd[0]); // padding
};

function DataRepository() { // Singleton pattern
  if (typeof DataRepository.instance === 'object') {
    return DataRepository.instance;
  }

  DataRepository.instance = this;
}



DataRepository.prototype._safeFetchPost = function(reqUrl: string,data: string) {
  console.log('reqUrl', reqUrl);
  return new Promise((resolve, reject) => {
    var fetchOptions = {
      method: 'POST',
      headers: {
        'Accept': 'text/html;charset=UTF-8',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body:'data='+data+''//这里我参数只有一个data,大家可以还有更多的参数
    };

    fetch(reqUrl, fetchOptions)
        .then((response) => response.text())
        .then((responseText) => {
          resolve(responseText);
        })
        .catch((error) => {
          console.error(error);
          resolve(null);
        });
  });
};



DataRepository.prototype.launchRequest = function(code: string, data: Object,
    callback?: ?(error: ?Error, result: ?Object) => void
) {

  var reqUrl = API_BASE_URL;
  var requestData = REQUEST_JSON;
  requestData.request_head.app_version = '2.0';
  requestData.request_head.appid='bl';
  requestData.request_head.process_code=code;
  var date = new Date();
  requestData.request_head.req_time=date.getTime();
  requestData.request_head.token='';
  requestData.request_head.uid=DeviceInfo.getUniqueID();

  requestData.request_body = data;
  var networking = this._safeFetchPost(reqUrl, JSON.stringify(requestData));

  return networking;
};


module.exports = DataRepository;
